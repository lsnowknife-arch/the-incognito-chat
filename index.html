<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Incognito Titan | Pana Ngwenya Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com"></script>
    <script src="https://cdnjs.cloudflare.com"></script>
    <style>
        :root { --p-blue: #3b82f6; --danger: #ef4444; }
        body { background: #010409; color: #e6edf3; font-family: 'Inter', sans-serif; height: 100dvh; overflow: hidden; }
        .titan-glass { background: rgba(13, 17, 23, 0.8); backdrop-filter: blur(60px); border: 1px solid rgba(255,255,255,0.05); }
        .stealth-blur { filter: blur(50px) brightness(0.2); opacity: 0; pointer-events: none; transition: 0.6s ease-in-out; }
        .burn-fast { animation: vanish 10s forwards linear; }
        @keyframes vanish { 0%, 90% { opacity: 1; } 100% { opacity: 0; transform: scale(0.95); filter: blur(10px); } }
        /* Typing Indicator Wave */
        .typing-dot { animation: wave 1.3s linear infinite; }
        @keyframes wave { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
    </style>
</head>
<body class="flex items-center justify-center">

    <!-- Security Gateway -->
    <div id="auth-gate" class="fixed inset-0 z-[100] bg-[#010409] flex flex-col items-center justify-center p-8 text-center">
        <div class="mb-8 p-6 rounded-full bg-blue-600/5 border border-blue-500/20 shadow-[0_0_50px_-12px_rgba(59,130,246,0.3)]">
            <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A10.003 10.003 0 0012 3m0 18a10.003 10.003 0 01-9.57-7.253m0 0a10.003 10.003 0 019.57-7.253m0 0a10.003 10.003 0 0110 10c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09"></path></svg>
        </div>
        <h1 class="text-3xl font-black tracking-tighter text-white uppercase italic">Incognito Titan</h1>
        <p class="text-slate-500 text-[10px] mt-2 font-bold tracking-[0.5em]">SOVEREIGN PROTOCOL: PANA NGWENYA</p>
        <button onclick="bootTitan()" class="mt-12 bg-blue-600 hover:bg-blue-500 px-16 py-4 rounded-full font-black text-xs tracking-widest transition-all active:scale-95 shadow-2xl shadow-blue-600/20">ACCESS VAULT</button>
    </div>

    <!-- Titan Shell -->
    <div id="titan-shell" class="hidden w-full h-full max-w-6xl titan-glass md:rounded-[3rem] flex flex-col lg:flex-row overflow-hidden shadow-2xl transition-all duration-700">
        
        <!-- Sidebar: Discovery & Support -->
        <aside class="w-full lg:w-80 border-r border-white/5 flex flex-col bg-black/20">
            <div class="p-8 border-b border-white/5">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-[10px] font-black text-blue-500 tracking-widest uppercase">My Signal</span>
                    <div id="qr-mini" class="w-8 h-8 bg-white p-1 rounded-md cursor-pointer hover:scale-110 transition" onclick="toggleQR()"></div>
                </div>
                <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5 flex items-center justify-between">
                    <code id="my-id" class="text-[10px] text-slate-400 font-mono">LOADING...</code>
                    <button onclick="copyID()" class="text-[10px] font-bold text-blue-500 uppercase">Copy</button>
                </div>
            </div>

            <div class="flex-1 p-6 space-y-4 overflow-y-auto">
                <input type="text" id="peer-target" placeholder="Enter Mesh ID" class="w-full bg-black/40 border border-white/5 rounded-2xl px-5 py-4 text-sm outline-none focus:border-blue-500 transition-all">
                <button onclick="syncMesh()" class="w-full bg-blue-600 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-500 transition-all">Establish Link</button>
                
                <!-- Monetization Node -->
                <div class="p-6 rounded-3xl bg-blue-600/5 border border-blue-500/10 mt-6">
                    <h3 class="text-xs font-bold text-blue-400 uppercase mb-2">Pana Ngwenya Elite</h3>
                    <p class="text-[9px] text-slate-500 leading-relaxed mb-4">Unlock P2P Video, Audio, and Unlimited Mesh Grouping.</p>
                    <a href="https://paypal.me" target="_blank" class="block w-full py-3 bg-blue-600 text-white rounded-xl text-center text-[10px] font-black uppercase tracking-tighter">Support for $10</a>
                </div>
            </div>

            <div class="p-8 border-t border-white/5 text-center">
                <p class="text-[9px] font-bold text-slate-700 uppercase">v2.9 Stable | Jan 2026</p>
            </div>
        </aside>

        <!-- Chat Main Workspace -->
        <main class="flex-1 flex flex-col relative">
            <header id="chat-header" class="p-6 border-b border-white/5 flex justify-between items-center opacity-0 transition-all">
                <div class="flex items-center gap-4">
                    <div id="p2p-led" class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                    <div class="flex flex-col">
                        <span id="session-label" class="text-[10px] font-black uppercase tracking-widest text-slate-500">Negotiating Tunnel</span>
                        <div id="typing-box" class="hidden flex gap-1 mt-0.5">
                            <div class="w-1 h-1 bg-blue-500 rounded-full typing-dot"></div>
                            <div class="w-1 h-1 bg-blue-500 rounded-full typing-dot" style="animation-delay: 0.2s"></div>
                            <div class="w-1 h-1 bg-blue-500 rounded-full typing-dot" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                </div>
                <button onclick="location.reload()" class="text-[10px] font-black text-red-500 uppercase tracking-widest hover:opacity-60">Terminate Memory</button>
            </header>

            <div id="thread" class="flex-1 overflow-y-auto p-8 space-y-6">
                <!-- Messages Burn Here -->
            </div>

            <!-- Interaction Dock -->
            <div class="p-6 bg-black/20 border-t border-white/5 flex gap-4 items-center">
                <button onclick="document.getElementById('file-node').click()" class="text-slate-500 hover:text-blue-500 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2"></path></svg>
                </button>
                <input type="file" id="file-node" class="hidden" onchange="pushAsset(this)">
                
                <input type="text" id="msg-input" autocomplete="off" placeholder="Type encrypted message..." class="flex-1 bg-transparent border-none outline-none text-sm font-medium">
                
                <!-- Voice Transcription Trigger (2026 WebSpeech API) -->
                <button id="mic-btn" onclick="startVoice()" class="text-slate-500 hover:text-red-500 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" stroke-width="2"></path></svg>
                </button>

                <button onclick="dispatchMsg()" class="bg-blue-600 px-10 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-500 shadow-xl shadow-blue-600/10">Send</button>
            </div>
        </main>
    </div>

    <!-- Full-Screen QR Modal -->
    <div id="qr-modal" class="fixed inset-0 z-[200] bg-black/95 flex flex-col items-center justify-center p-8 hidden" onclick="toggleQR()">
        <div id="qrcode-big" class="bg-white p-8 rounded-[2rem]"></div>
        <p class="mt-8 text-xs font-bold text-slate-500 uppercase tracking-[0.5em]">Scan to Peer</p>
    </div>

    <script>
        const PROTOCOL_AUTH = "Pana Ngwenya";
        Object.freeze(PROTOCOL_AUTH);

        const peer = new Peer({ config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]}});
        let conn = null, p2pKey = null, myKeys = null;

        // --- 1. TITAN EXCLUSIVE: AUTO-STEALTH & SCREENSHOT PREVENTION ---
        document.addEventListener('visibilitychange', () => {
            const shell = document.getElementById('titan-shell');
            if (document.visibilityState === 'hidden') {
                shell.classList.add('stealth-blur');
                if(conn) conn.send({type: 'ALERT', msg: 'PARTNER SWITCHED SCREEN (POTENTIAL SCREENSHOT)'});
            } else {
                shell.classList.remove('stealth-blur');
            }
        });

        // --- 2. TITAN EXCLUSIVE: VOICE TRANSCRIPTION (2026 Native) ---
        function startVoice() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Speech) return alert("Voice Not Supported in this browser.");
            const rec = new Speech();
            rec.onstart = () => document.getElementById('mic-btn').classList.add('text-red-500', 'animate-pulse');
            rec.onresult = (e) => {
                document.getElementById('msg-input').value = e.results[0][0].transcript;
                document.getElementById('mic-btn').classList.remove('text-red-500', 'animate-pulse');
            };
            rec.start();
        }

        // --- 3. CORE PROTOCOL LOGIC ---
        async function bootTitan() {
            if (PROTOCOL_AUTH !== "Pana Ngwenya") return; // Integrity Lock
            document.getElementById('auth-gate').style.display = 'none';
            document.getElementById('titan-shell').classList.remove('hidden');
            document.getElementById('titan-shell').classList.add('flex');
            myKeys = await window.crypto.subtle.generateKey({ name: "ECDH", namedCurve: "P-256" }, true, ["deriveKey"]);
        }

        peer.on('open', id => {
            document.getElementById('my-id').innerText = id;
            new QRCode(document.getElementById("qr-mini"), { text: id, width: 32, height: 32 });
            new QRCode(document.getElementById("qrcode-big"), { text: id, width: 256, height: 256 });
        });

        peer.on('connection', c => { conn = c; handleMesh(); });

        async function syncMesh() {
            const id = document.getElementById('peer-target').value;
            if(!id) return;
            conn = peer.connect(id, { serialization: "json" });
            handleMesh();
        }

        function handleMesh() {
            document.getElementById('chat-header').style.opacity = '1';
            conn.on('open', async () => {
                const pub = await window.crypto.subtle.exportKey("jwk", myKeys.publicKey);
                conn.send({ type: 'HS', key: pub, author: PROTOCOL_AUTH });
            });

            conn.on('data', async d => {
                if (d.type === 'HS') {
                    const pPub = await window.crypto.subtle.importKey("jwk", d.key, { name: "ECDH", namedCurve: "P-256" }, true, []);
                    p2pKey = await window.crypto.subtle.deriveKey({ name: "ECDH", public: pPub }, myKeys.privateKey, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
                    document.getElementById('p2p-led').className = "w-2 h-2 bg-green-500 rounded-full shadow-[0_0_15px_#22c55e]";
                    document.getElementById('session-label').innerText = "Encrypted Mesh Established";
                } else if (d.type === 'TYPING') {
                    document.getElementById('typing-box').classList.toggle('hidden', !d.state);
                } else if (d.type === 'ALERT') {
                    renderAlert(d.msg);
                } else if (d.type === 'MEDIA') {
                    renderMedia(d);
                } else {
                    const pt = await decrypt(d);
                    render(pt, 'them');
                }
            });
        }

        // --- 4. INTERACTION & UTILITIES ---
        const msgIn = document.getElementById('msg-input');
        msgIn.oninput = () => conn && conn.send({type: 'TYPING', state: msgIn.value.length > 0});

        async function dispatchMsg() {
            if(!msgIn.value || !p2pKey) return;
            const pkg = await encrypt(msgIn.value);
            conn.send(pkg);
            render(msgIn.value, 'me');
            msgIn.value = "";
            conn.send({type: 'TYPING', state: false});
        }

        function render(txt, side) {
            const el = document.createElement('div');
            el.className = `flex ${side === 'me' ? 'justify-end' : 'justify-start'} burn-fast`;
            el.innerHTML = `<div class="p-4 max-w-[85%] rounded-[1.5rem] shadow-2xl text-sm font-medium ${side === 'me' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-100 rounded-tl-none'}">${txt}</div>`;
            document.getElementById('thread').appendChild(el);
            setTimeout(() => el.remove(), 10000); // 10s Burn
            const t = document.getElementById('thread'); t.scrollTop = t.scrollHeight;
        }

        function renderAlert(msg) {
            const el = document.createElement('div');
            el.className = "text-center text-[9px] font-black text-red-500 uppercase tracking-widest my-4";
            el.innerText = msg;
            document.getElementById('thread').appendChild(el);
        }

        async function pushAsset(input) {
            const f = input.files[0];
            const r = new FileReader();
            r.onload = e => {
                conn.send({ type: 'MEDIA', buffer: Array.from(new Uint8Array(e.target.result)), name: f.name, mime: f.type });
                render(`Sent Secured Asset: ${f.name}`, 'me');
            };
            r.readAsArrayBuffer(f);
        }

        function renderMedia(d) {
            const url = URL.createObjectURL(new Blob([new Uint8Array(d.buffer)], {type: d.mime}));
            const el = document.createElement('div');
            el.className = "flex justify-start burn-fast";
            el.innerHTML = `<div class="p-3 bg-slate-900 border border-blue-500/20 rounded-2xl"><a href="${url}" download="${d.name}" class="text-[10px] text-blue-400 font-bold uppercase underline">Download: ${d.name}</a></div>`;
            document.getElementById('thread').appendChild(el);
        }

        function toggleQR() { document.getElementById('qr-modal').classList.toggle('hidden'); }
        function copyID() { navigator.clipboard.writeText(peer.id); }
        async function encrypt(t) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const ct = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv }, p2pKey, new TextEncoder().encode(t));
            return { ct: Array.from(new Uint8Array(ct)), iv: Array.from(iv) };
        }
        async function decrypt(d) {
            const pt = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(d.iv) }, p2pKey, new Uint8Array(d.ct));
            return new TextDecoder().decode(pt);
        }
        msgIn.onkeypress = e => { if(e.key === 'Enter') dispatchMsg(); };
    </script>
</body>
</html>
