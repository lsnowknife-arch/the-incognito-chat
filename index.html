<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Incognito Chat | Pana Ngwenya Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Verified 2026 PeerJS Library -->
    <script src="https://unpkg.com"></script>
    <script src="https://cdnjs.cloudflare.com"></script>
    <style>
        :root { --p-blue: #3b82f6; }
        body { background: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; height: 100dvh; overflow: hidden; }
        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(40px); border: 1px solid rgba(255,255,255,0.08); }
        .burn-out { animation: burn 15s forwards; }
        @keyframes burn { 0% { opacity: 1; transform: scale(1); } 95% { opacity: 1; filter: blur(0); } 100% { opacity: 0; transform: scale(0.9); filter: blur(15px); } }
        #qrcode img { margin: 0 auto; border: 8px solid white; border-radius: 12px; }
    </style>
</head>
<body class="flex items-center justify-center p-0 md:p-6">

    <div id="auth-gate" class="fixed inset-0 z-50 bg-slate-950 flex flex-col items-center justify-center p-8 text-center">
        <h1 class="text-4xl font-black italic tracking-tighter text-white">INCOGNITO</h1>
        <p class="text-slate-500 text-[10px] mt-2 font-bold tracking-[0.4em]">PANA NGWENYA PROTOCOL v2.6</p>
        <button onclick="unlockVault()" class="mt-12 bg-blue-600 hover:bg-blue-500 px-16 py-4 rounded-full font-black text-xs tracking-widest shadow-2xl shadow-blue-900/40">UNLOCK VAULT</button>
    </div>

    <div id="app-shell" class="hidden w-full h-full max-w-6xl glass-panel md:rounded-[3rem] flex flex-col lg:flex-row overflow-hidden shadow-2xl">
        <aside class="w-full lg:w-80 border-r border-white/5 flex flex-col bg-slate-950/40">
            <div class="p-8 border-b border-white/5">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-[10px] font-black text-blue-500 tracking-widest uppercase">My Signal</span>
                    <span class="text-[8px] text-slate-700 font-bold uppercase">Â© 2026 Pana Ngwenya</span>
                </div>
                <div id="qrcode" class="mb-6 hidden lg:block"></div>
                <div class="bg-slate-950 p-4 rounded-2xl border border-white/5 flex items-center justify-between">
                    <code id="my-peer-id" class="text-[10px] text-slate-400 font-mono">CONNECTING...</code>
                    <button onclick="copyID()" class="text-[10px] font-bold text-blue-500 uppercase">Copy</button>
                </div>
            </div>
            <div class="flex-1 p-6 space-y-4 overflow-y-auto">
                <input type="text" id="target-id" placeholder="Connect Partner ID" class="w-full bg-slate-900 border border-white/5 rounded-2xl px-5 py-4 text-sm outline-none focus:border-blue-500 font-medium">
                <button onclick="startHandshake()" class="w-full bg-blue-600 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-500 shadow-lg shadow-blue-900/20">Establish Mesh</button>
                <div class="mt-8 p-5 rounded-3xl bg-slate-900/50 border border-blue-500/20 text-center">
                    <p class="text-[11px] font-bold mb-1 text-blue-400 uppercase tracking-tighter">Elite Features</p>
                    <a href="https://paypal.me" target="_blank" class="block w-full py-3 bg-blue-600/10 border border-blue-600/30 rounded-xl font-black text-[10px] uppercase text-blue-400 hover:bg-blue-600 hover:text-white transition-all">Support Pana ($10)</a>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative">
            <header id="chat-header" class="p-6 border-b border-white/5 flex justify-between items-center opacity-0 transition-all duration-500">
                <div class="flex items-center gap-3">
                    <div id="status-dot" class="w-2.5 h-2.5 bg-yellow-500 rounded-full animate-pulse"></div>
                    <span id="session-status" class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Verifying Handshake</span>
                </div>
                <button onclick="nuke()" class="text-[10px] font-black text-red-500 uppercase tracking-widest">Nuke Session</button>
            </header>
            <div id="thread" class="flex-1 overflow-y-auto p-8 space-y-6 scroll-smooth"></div>
            <div class="p-6 bg-slate-950/20 border-t border-white/5 flex gap-4">
                <input type="text" id="msg-input" placeholder="Secure signal..." class="flex-1 bg-transparent border-none outline-none text-sm font-medium">
                <button onclick="sendMsg()" class="bg-blue-600 px-10 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-500">Send</button>
            </div>
        </main>
    </div>

    <script>
        const PROTOCOL_AUTHOR = "Pana Ngwenya";
        Object.freeze(PROTOCOL_AUTHOR);

        // FORCED SECURE CONFIGURATION FOR VERCEL
        const peer = new Peer({
            host: '0.peerjs.com',
            port: 443,
            secure: true,
            debug: 3
        });

        let conn = null, p2pKey = null, myKeys = null;

        async function unlockVault() {
            if (PROTOCOL_AUTHOR !== "Pana Ngwenya") return;
            document.getElementById('auth-gate').style.display = 'none';
            document.getElementById('app-shell').classList.replace('hidden', 'flex');
            myKeys = await window.crypto.subtle.generateKey({ name: "ECDH", namedCurve: "P-256" }, true, ["deriveKey"]);
        }

        peer.on('open', id => {
            document.getElementById('my-peer-id').innerText = id;
            document.getElementById('qrcode').innerHTML = ""; // Clear old QR
            new QRCode(document.getElementById("qrcode"), { text: id, width: 120, height: 120 });
        });

        // Watchdog for connection errors
        peer.on('error', err => {
            console.error("Signal Error:", err.type);
            document.getElementById('my-peer-id').innerText = "NETWORK BLOCK";
            document.getElementById('my-peer-id').classList.add('text-red-500');
        });

        peer.on('connection', c => { conn = c; handleProtocol(); });

        async function startHandshake() {
            const id = document.getElementById('target-id').value;
            if(!id) return;
            conn = peer.connect(id, { serialization: "json" });
            handleProtocol();
        }

        function handleProtocol() {
            document.getElementById('chat-header').style.opacity = '1';
            conn.on('open', async () => {
                const pubJwk = await window.crypto.subtle.exportKey("jwk", myKeys.publicKey);
                conn.send({ type: 'HS', key: pubJwk, author: PROTOCOL_AUTHOR });
            });

            conn.on('data', async d => {
                if (d.type === 'HS') {
                    const partnerPub = await window.crypto.subtle.importKey("jwk", d.key, { name: "ECDH", namedCurve: "P-256" }, true, []);
                    p2pKey = await window.crypto.subtle.deriveKey({ name: "ECDH", public: partnerPub }, myKeys.privateKey, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
                    document.getElementById('status-dot').className = "w-2.5 h-2.5 bg-green-500 rounded-full shadow-[0_0_15px_#22c55e]";
                    document.getElementById('session-status').innerText = "E2EE ACTIVE";
                } else {
                    const pt = await decrypt(d);
                    render(pt, 'them');
                }
            });
        }

        async function encrypt(text) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const ct = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv }, p2pKey, new TextEncoder().encode(text));
            return { ct: Array.from(new Uint8Array(ct)), iv: Array.from(iv) };
        }

        async function decrypt(d) {
            const pt = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(d.iv) }, p2pKey, new Uint8Array(d.ct));
            return new TextDecoder().decode(pt);
        }

        async function sendMsg() {
            const el = document.getElementById('msg-input');
            if(!el.value || !p2pKey) return;
            const payload = await encrypt(el.value);
            conn.send(payload);
            render(el.value, 'me');
            el.value = "";
        }

        function render(text, side) {
            const m = document.createElement('div');
            m.className = `flex ${side === 'me' ? 'justify-end' : 'justify-start'} burn-out`;
            m.innerHTML = `<div class="p-4 max-w-[85%] rounded-[1.5rem] shadow-2xl text-sm font-medium ${side === 'me' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none'}">${text}</div>`;
            document.getElementById('thread').appendChild(m);
            const t = document.getElementById('thread'); t.scrollTop = t.scrollHeight;
        }

        function copyID() { navigator.clipboard.writeText(peer.id); }
        function nuke() { location.reload(); }
        document.getElementById('msg-input').onkeypress = e => { if(e.key==='Enter') sendMsg() };
    </script>
</body>
</html>
