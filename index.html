<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Incognito Chat | Pana Ngwenya Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background: #010409; color: #e6edf3; font-family: 'Inter', sans-serif; height: 100dvh; overflow: hidden; }
        .glass-ui { background: rgba(13, 17, 23, 0.8); backdrop-filter: blur(50px); border: 1px solid rgba(255,255,255,0.08); }
        .burn-out { animation: burnEffect 12s forwards; }
        @keyframes burnEffect { 0%, 90% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.9); filter: blur(15px); } }
        #qrcode img { margin: 0 auto; border: 4px solid white; border-radius: 12px; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="flex items-center justify-center p-0 md:p-6">

    <div id="auth-gate" class="fixed inset-0 z-50 bg-[#010409] flex flex-col items-center justify-center p-8 text-center">
        <h1 class="text-5xl font-black italic tracking-tighter text-white mb-2">INCOGNITO</h1>
        <p class="text-blue-500 text-[10px] font-bold tracking-[0.5em] uppercase mb-12">Pana Ngwenya Secure Mesh</p>
        <button onclick="igniteVault()" class="bg-blue-600 hover:bg-blue-500 px-16 py-5 rounded-full font-black text-xs tracking-widest shadow-[0_0_40px_rgba(59,130,246,0.3)] transition-all active:scale-95 text-white">INITIALIZE LINK</button>
    </div>

    <div id="app-shell" class="hidden w-full h-full max-w-6xl glass-ui md:rounded-[2.5rem] flex flex-col lg:flex-row overflow-hidden shadow-2xl">
        
        <aside class="w-full lg:w-80 border-r border-white/5 flex flex-col bg-black/40">
            <div class="p-8">
                <div id="qrcode" class="mb-6 hidden lg:block"></div>
                <div class="space-y-4">
                    <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5 relative group">
                        <p class="text-[9px] text-slate-500 font-bold uppercase mb-1">Your Signal ID</p>
                        <code id="my-peer-id" class="text-xs text-blue-400 font-mono break-all">GENERATING...</code>
                        <button onclick="copyID()" class="absolute top-4 right-4 text-[9px] font-bold text-blue-500 opacity-0 group-hover:opacity-100 uppercase transition-all">Copy</button>
                    </div>
                    <input type="text" id="target-id" placeholder="Paste Partner ID" class="w-full bg-black/50 border border-white/10 rounded-2xl px-5 py-4 text-sm outline-none focus:border-blue-500 text-white transition-all">
                    <button onclick="connectMesh()" class="w-full bg-blue-600 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-500 shadow-lg text-white">Link P2P Tunnel</button>
                </div>
            </div>
            
            <div class="mt-auto p-8 border-t border-white/5">
                <div class="flex items-center gap-3">
                    <div id="status-dot" class="w-2.5 h-2.5 bg-yellow-500 rounded-full animate-pulse"></div>
                    <span id="session-status" class="text-[10px] font-black uppercase tracking-widest text-slate-400">System Idle</span>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-950/20">
            <div id="thread" class="flex-1 overflow-y-auto p-6 md:p-10 space-y-6 flex flex-col">
                <div id="splash" class="my-auto text-center opacity-20">
                    <p class="text-[10px] font-black tracking-[1em] text-slate-500">AWAITING HANDSHAKE</p>
                </div>
            </div>

            <div class="p-6 bg-black/20 border-t border-white/5 flex gap-4 items-center">
                <input type="text" id="msg-input" placeholder="Secure message..." class="flex-1 bg-transparent border-none outline-none text-sm font-medium text-white">
                <button onclick="sendMsg()" class="bg-blue-600 px-8 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-500 text-white transition-all">Send</button>
            </div>
        </main>
    </div>

    <script>
        const AUTHOR = "Pana Ngwenya";
        let peer, conn, p2pKey, myKeys;

        async function igniteVault() {
            document.getElementById('auth-gate').style.display = 'none';
            const shell = document.getElementById('app-shell');
            shell.classList.remove('hidden');
            shell.classList.add('flex');
            
            // Generate ECDH Keys for E2EE
            myKeys = await window.crypto.subtle.generateKey(
                { name: "ECDH", namedCurve: "P-256" }, 
                true, ["deriveKey"]
            );

            setupPeer();
        }

        function setupPeer() {
            // High-Performance Config: Google STUN + OpenRelay TURN (UDP/TCP/TLS)
            peer = new Peer({
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { 
                            urls: 'turn:openrelay.metered.ca:80', 
                            username: 'openrelayproject', 
                            password: 'openrelayproject' 
                        },
                        { 
                            urls: 'turn:openrelay.metered.ca:443?transport=tcp', 
                            username: 'openrelayproject', 
                            password: 'openrelayproject' 
                        }
                    ],
                    'iceTransportPolicy': 'all',
                    'iceCandidatePoolSize': 10
                }
            });

            peer.on('open', id => {
                document.getElementById('my-peer-id').innerText = id;
                document.getElementById('session-status').innerText = "Signal Ready";
                new QRCode(document.getElementById("qrcode"), { text: id, width: 160, height: 160 });
            });

            peer.on('connection', c => {
                conn = c;
                initMeshLogic();
            });

            peer.on('error', err => {
                console.error("PeerJS Error:", err.type);
                document.getElementById('session-status').innerText = `Error: ${err.type}`;
            });
        }

        async function connectMesh() {
            const id = document.getElementById('target-id').value.trim();
            if(!id) return;
            // reliable: true ensures no packet loss
            conn = peer.connect(id, { serialization: 'binary-utf8', reliable: true });
            initMeshLogic();
        }

        function initMeshLogic() {
            document.getElementById('splash').style.display = 'none';
            document.getElementById('session-status').innerText = "Negotiating...";

            // Robust Handshake: Sends public key as soon as channel opens
            const sendHandshake = async () => {
                const pubJwk = await window.crypto.subtle.exportKey("jwk", myKeys.publicKey);
                conn.send({ type: 'HANDSHAKE', key: pubJwk });
            };

            if (conn.open) sendHandshake();
            else conn.on('open', sendHandshake);

            conn.on('data', async (data) => {
                if (data.type === 'HANDSHAKE') {
                    const partnerPub = await window.crypto.subtle.importKey(
                        "jwk", data.key, 
                        { name: "ECDH", namedCurve: "P-256" }, 
                        true, []
                    );
                    p2pKey = await window.crypto.subtle.deriveKey(
                        { name: "ECDH", public: partnerPub }, 
                        myKeys.privateKey, 
                        { name: "AES-GCM", length: 256 }, 
                        true, ["encrypt", "decrypt"]
                    );
                    
                    document.getElementById('status-dot').className = "w-2.5 h-2.5 bg-green-500 rounded-full shadow-[0_0_15px_#22c55e]";
                    document.getElementById('session-status').innerText = "E2EE ACTIVE";
                } else if (p2pKey) {
                    const pt = await decrypt(data);
                    render(pt, 'them');
                }
            });

            conn.on('close', () => {
                document.getElementById('session-status').innerText = "Mesh Collapsed";
                document.getElementById('status-dot').className = "w-2.5 h-2.5 bg-red-500 rounded-full";
            });
        }

        async function encrypt(text) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const ct = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv }, p2pKey, new TextEncoder().encode(text));
            return { ct: Array.from(new Uint8Array(ct)), iv: Array.from(iv) };
        }

        async function decrypt(d) {
            const pt = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(d.iv) }, p2pKey, new Uint8Array(d.ct));
            return new TextDecoder().decode(pt);
        }

        async function sendMsg() {
            const input = document.getElementById('msg-input');
            if(!input.value || !p2pKey) return;
            const payload = await encrypt(input.value);
            conn.send(payload);
            render(input.value, 'me');
            input.value = "";
        }

        function render(text, side) {
            const m = document.createElement('div');
            m.className = `flex ${side === 'me' ? 'justify-end' : 'justify-start'} burn-out`;
            m.innerHTML = `<div class="p-4 max-w-[85%] rounded-[1.5rem] shadow-xl text-sm ${side === 'me' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none'}">${text}</div>`;
            document.getElementById('thread').appendChild(m);
            setTimeout(() => m.remove(), 12000); 
            const t = document.getElementById('thread'); t.scrollTop = t.scrollHeight;
        }

        function copyID() { 
            const id = document.getElementById('my-peer-id').innerText;
            navigator.clipboard.writeText(id); 
        }
        document.getElementById('msg-input').onkeypress = e => e.key === 'Enter' && sendMsg();
    </script>
</body>
</html>