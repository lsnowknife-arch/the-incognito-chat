<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Incognito Chat | Absolute P2P</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background: #010409; color: #e6edf3; font-family: sans-serif; height: 100dvh; overflow: hidden; }
        .glass-ui { background: rgba(13, 17, 23, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .burn-out { animation: burn 10s forwards; }
        @keyframes burn { 0%, 90% { opacity: 1; } 100% { opacity: 0; filter: blur(10px); } }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div id="auth-gate" class="fixed inset-0 z-50 bg-[#010409] flex flex-col items-center justify-center p-8 text-center">
        <h1 class="text-3xl font-black text-white italic mb-8 tracking-tighter">INCOGNITO v2.7</h1>
        <button onclick="igniteVault()" class="bg-blue-600 px-12 py-4 rounded-full font-bold text-xs uppercase tracking-widest text-white shadow-2xl">Start Secure Session</button>
    </div>

    <div id="app-shell" class="hidden w-full h-full max-w-4xl glass-ui rounded-3xl flex flex-col overflow-hidden">
        <div class="p-6 border-b border-white/5 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div id="status-dot" class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                <code id="my-peer-id" class="text-[10px] text-blue-400 font-mono font-bold">BOOTING SIGNAL...</code>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <input type="text" id="target-id" placeholder="Partner ID" class="flex-1 md:w-48 bg-black border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-blue-500">
                <button onclick="connectMesh()" class="bg-blue-600 px-4 py-2 rounded-lg font-bold text-[10px] uppercase text-white">Connect</button>
            </div>
        </div>

        <div id="thread" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

        <div class="p-4 bg-black/40 border-t border-white/5 flex gap-3">
            <input type="text" id="msg-input" placeholder="Message..." class="flex-1 bg-transparent outline-none text-sm text-white">
            <button onclick="sendMsg()" class="bg-blue-600 px-6 py-2 rounded-lg font-bold text-[10px] uppercase text-white">Send</button>
        </div>
    </div>

    <script>
        let peer, conn, p2pKey, myKeys;

        async function igniteVault() {
            document.getElementById('auth-gate').style.display = 'none';
            document.getElementById('app-shell').style.display = 'flex';
            myKeys = await crypto.subtle.generateKey({ name: "ECDH", namedCurve: "P-256" }, true, ["deriveKey"]);
            initPeer();
        }

        function initPeer() {
            // FORCED RELAY MODE: Uses Google and multiple public TURN fallbacks
            peer = new Peer({
                debug: 3,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' },
                        { 
                          urls: [
                            'turn:openrelay.metered.ca:80',
                            'turn:openrelay.metered.ca:443',
                            'turn:openrelay.metered.ca:443?transport=tcp'
                          ], 
                          username: 'openrelayproject', 
                          password: 'openrelayproject' 
                        }
                    ],
                    'iceCandidatePoolSize': 10
                }
            });

            peer.on('open', id => {
                document.getElementById('my-peer-id').innerText = id;
                document.getElementById('status-dot').className = "w-3 h-3 bg-blue-500 rounded-full animate-pulse";
            });

            peer.on('connection', c => {
                conn = c;
                bindEvents();
            });

            peer.on('error', err => {
                console.error("PeerJS Error:", err.type);
                alert("Connection Error: " + err.type);
            });
        }

        function connectMesh() {
            const id = document.getElementById('target-id').value.trim();
            if (!id) return;
            // Force reliable:true to prevent data loss on high-latency networks
            conn = peer.connect(id, { reliable: true });
            bindEvents();
        }

        function bindEvents() {
            conn.on('open', async () => {
                const pubJwk = await crypto.subtle.exportKey("jwk", myKeys.publicKey);
                conn.send({ type: 'HS', key: pubJwk });
                document.getElementById('status-dot').className = "w-3 h-3 bg-green-500 rounded-full shadow-[0_0_10px_#22c55e]";
            });

            conn.on('data', async data => {
                if (data.type === 'HS') {
                    const partnerPub = await crypto.subtle.importKey("jwk", data.key, { name: "ECDH", namedCurve: "P-256" }, true, []);
                    p2pKey = await crypto.subtle.deriveKey({ name: "ECDH", public: partnerPub }, myKeys.privateKey, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
                } else if (p2pKey) {
                    const decrypted = await decrypt(data);
                    render(decrypted, 'them');
                }
            });

            conn.on('error', () => {
                document.getElementById('status-dot').className = "w-3 h-3 bg-red-600 rounded-full";
            });
        }

        async function encrypt(t) {
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const ct = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, p2pKey, new TextEncoder().encode(t));
            return { ct: Array.from(new Uint8Array(ct)), iv: Array.from(iv) };
        }

        async function decrypt(d) {
            const pt = await crypto.subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(d.iv) }, p2pKey, new Uint8Array(d.ct));
            return new TextDecoder().decode(pt);
        }

        async function sendMsg() {
            const input = document.getElementById('msg-input');
            if (!input.value || !p2pKey) return;
            const payload = await encrypt(input.value);
            conn.send(payload);
            render(input.value, 'me');
            input.value = "";
        }

        function render(text, side) {
            const div = document.createElement('div');
            div.className = `flex ${side === 'me' ? 'justify-end' : 'justify-start'} burn-out`;
            div.innerHTML = `<div class="p-3 px-5 max-w-[80%] rounded-2xl text-sm ${side === 'me' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none'}">${text}</div>`;
            document.getElementById('thread').appendChild(div);
            const t = document.getElementById('thread'); t.scrollTop = t.scrollHeight;
        }

        document.getElementById('msg-input').onkeydown = e => e.key === 'Enter' && sendMsg();
    </script>
</body>
</html>