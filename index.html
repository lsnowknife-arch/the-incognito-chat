<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Incognito Chat | Pana Ngwenya Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { --p-blue: #3b82f6; }
        body { background: #010409; color: #e6edf3; font-family: 'Inter', sans-serif; height: 100dvh; overflow: hidden; }
        .glass-ui { background: rgba(13, 17, 23, 0.8); backdrop-filter: blur(50px); border: 1px solid rgba(255,255,255,0.06); }
        .stealth-blur { filter: blur(40px) brightness(0.3); opacity: 0.1; transition: 0.5s ease; }
        .burn-out { animation: burnEffect 12s forwards; }
        @keyframes burnEffect { 0%, 90% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.9); filter: blur(15px); } }
        #qrcode img { margin: 0 auto; border: 4px solid white; border-radius: 8px; }
    </style>
</head>
<body class="flex items-center justify-center p-0 md:p-6">

    <div id="auth-gate" class="fixed inset-0 z-50 bg-[#010409] flex flex-col items-center justify-center p-8 text-center">
        <h1 class="text-4xl font-black italic tracking-tighter text-white">INCOGNITO</h1>
        <p class="text-slate-500 text-[10px] mt-2 font-bold tracking-[0.5em] uppercase">Pana Ngwenya Protocol v2.6</p>
        <button onclick="igniteVault()" class="mt-12 bg-blue-600 hover:bg-blue-500 px-16 py-4 rounded-full font-black text-xs tracking-widest shadow-2xl shadow-blue-900/40 transition-all active:scale-95">BOOT VAULT</button>
    </div>

    <div id="app-shell" class="hidden w-full h-full max-w-6xl glass-ui md:rounded-[3rem] flex flex-col lg:flex-row overflow-hidden shadow-2xl">
        
        <aside class="w-full lg:w-80 border-r border-white/5 flex flex-col bg-black/20">
            <div class="p-8 border-b border-white/5">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-[10px] font-black text-blue-500 tracking-widest uppercase">My Signal</span>
                    <span class="text-[8px] text-slate-700 font-bold uppercase">Â© 2026 Pana Ngwenya</span>
                </div>
                <div id="qrcode" class="mb-6 hidden lg:block flex justify-center"></div>
                <div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 flex items-center justify-between group">
                    <code id="my-peer-id" class="text-[10px] text-slate-400 font-mono">INITIALIZING...</code>
                    <button onclick="copyID()" class="text-[10px] font-bold text-blue-500 opacity-0 group-hover:opacity-100 uppercase transition-all">Copy</button>
                </div>
            </div>
            
            <div class="flex-1 p-8 space-y-4 overflow-y-auto">
                <input type="text" id="target-id" placeholder="Connect Partner ID" class="w-full bg-slate-950 border border-white/5 rounded-2xl px-5 py-4 text-sm outline-none focus:border-blue-500 font-medium text-white">
                <button onclick="connectMesh()" class="w-full bg-blue-600 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-500 shadow-lg shadow-blue-900/20">Link P2P Tunnel</button>
                
                <div class="mt-12 p-6 rounded-3xl bg-blue-600/5 border border-blue-500/10 text-center">
                    <p class="text-[11px] font-bold mb-1 text-blue-400 uppercase">Premium Features</p>
                    <a href="#" class="block w-full py-3 bg-blue-600 text-white rounded-xl font-black text-[10px] uppercase tracking-tighter mt-4">Upgrade $10</a>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-slate-950/20">
            <header id="chat-header" class="p-6 border-b border-white/5 flex justify-between items-center opacity-0 transition-all">
                <div class="flex items-center gap-3">
                    <div id="status-dot" class="w-2.5 h-2.5 bg-yellow-500 rounded-full animate-pulse"></div>
                    <span id="session-status" class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Negotiating Mesh</span>
                </div>
                <button onclick="location.reload()" class="text-[10px] font-black text-red-500 uppercase tracking-widest">Nuke Session</button>
            </header>

            <div id="thread" class="flex-1 overflow-y-auto p-8 space-y-6">
                <div id="splash" class="h-full flex flex-col items-center justify-center opacity-20 text-center space-y-2">
                    <p class="text-[10px] font-black tracking-[0.5em] text-slate-600">AWAITING HANDSHAKE</p>
                </div>
            </div>

            <div class="p-6 bg-slate-950/20 border-t border-white/5 flex gap-4">
                <input type="text" id="msg-input" placeholder="Message..." class="flex-1 bg-transparent border-none outline-none text-sm font-medium text-white">
                <button onclick="sendMsg()" class="bg-blue-600 px-10 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-500">Send</button>
            </div>
        </main>
    </div>

    <script>
        const AUTHOR = "Pana Ngwenya";
        let peer, conn, p2pKey, myKeys;

        // Stealth Cloak
        document.addEventListener('visibilitychange', () => {
            const shell = document.getElementById('app-shell');
            if (document.visibilityState === 'hidden') shell.classList.add('stealth-blur');
            else shell.classList.remove('stealth-blur');
        });

        async function igniteVault() {
            document.getElementById('auth-gate').style.display = 'none';
            document.getElementById('app-shell').classList.remove('hidden');
            document.getElementById('app-shell').classList.add('flex');
            
            // Generate E2EE Keys
            myKeys = await window.crypto.subtle.generateKey(
                { name: "ECDH", namedCurve: "P-256" }, 
                true, 
                ["deriveKey"]
            );

            initPeer();
        }

        function initPeer() {
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                secure: true,
                debug: 1,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun.cloudflare.com:3478' }
                    ]
                }
            });

            peer.on('open', id => {
                document.getElementById('my-peer-id').innerText = id;
                if(window.QRCode) {
                    new QRCode(document.getElementById("qrcode"), { text: id, width: 120, height: 120 });
                }
            });

            peer.on('connection', c => {
                conn = c;
                setupMeshListeners();
            });

            peer.on('error', err => {
                console.error("Peer Error:", err);
                document.getElementById('my-peer-id').innerText = "CONNECTION ERROR";
            });
        }

        async function connectMesh() {
            const id = document.getElementById('target-id').value;
            if(!id) return;
            conn = peer.connect(id, { serialization: "json", reliable: true });
            setupMeshListeners();
        }

        function setupMeshListeners() {
            document.getElementById('splash').style.display = 'none';
            document.getElementById('chat-header').style.opacity = '1';

            conn.on('open', async () => {
                // Send Public Key for Handshake
                const pubJwk = await window.crypto.subtle.exportKey("jwk", myKeys.publicKey);
                conn.send({ type: 'HS', key: pubJwk });
            });

            conn.on('data', async d => {
                if (d.type === 'HS') {
                    const partnerPub = await window.crypto.subtle.importKey(
                        "jwk", d.key, 
                        { name: "ECDH", namedCurve: "P-256" }, 
                        true, []
                    );
                    p2pKey = await window.crypto.subtle.deriveKey(
                        { name: "ECDH", public: partnerPub }, 
                        myKeys.privateKey, 
                        { name: "AES-GCM", length: 256 }, 
                        true, ["encrypt", "decrypt"]
                    );
                    document.getElementById('status-dot').className = "w-2.5 h-2.5 bg-green-500 rounded-full shadow-[0_0_15px_#22c55e]";
                    document.getElementById('session-status').innerText = "E2EE ACTIVE";
                } else if (p2pKey) {
                    const pt = await decrypt(d);
                    render(pt, 'them');
                }
            });
        }

        async function encrypt(text) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const ct = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv }, p2pKey, new TextEncoder().encode(text));
            return { ct: Array.from(new Uint8Array(ct)), iv: Array.from(iv) };
        }

        async function decrypt(d) {
            const pt = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(d.iv) }, p2pKey, new Uint8Array(d.ct));
            return new TextDecoder().decode(pt);
        }

        async function sendMsg() {
            const el = document.getElementById('msg-input');
            if(!el.value || !p2pKey) return;
            const payload = await encrypt(el.value);
            conn.send(payload);
            render(el.value, 'me');
            el.value = "";
        }

        function render(text, side) {
            const m = document.createElement('div');
            m.className = `flex ${side === 'me' ? 'justify-end' : 'justify-start'} burn-out`;
            m.innerHTML = `<div class="p-4 max-w-[85%] rounded-[1.5rem] shadow-2xl text-sm font-medium ${side === 'me' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none'}">${text}</div>`;
            document.getElementById('thread').appendChild(m);
            setTimeout(() => m.remove(), 12000); 
            const t = document.getElementById('thread'); t.scrollTop = t.scrollHeight;
        }

        function copyID() { navigator.clipboard.writeText(peer.id); }
        document.getElementById('msg-input').onkeypress = e => { if(e.key==='Enter') sendMsg() };
    </script>
</body>
</html>